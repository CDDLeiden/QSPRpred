<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qsprpred.data.data &mdash; QSPRpred 1.3.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            QSPRpred
          </a>
              <div class="version">
                v1.3.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome to QSPRpredâ€™s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../use.html#cli-example">CLI Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">Python API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">QSPRpred</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qsprpred.data.data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qsprpred.data.data</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains the QSPRDataset that holds and prepares data for modelling.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">concurrent</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">qsprpred.data.interfaces</span> <span class="kn">import</span> <span class="n">MoleculeDataSet</span><span class="p">,</span> <span class="n">datasplit</span>
<span class="kn">from</span> <span class="nn">qsprpred.data.utils.descriptorcalculator</span> <span class="kn">import</span> <span class="n">Calculator</span><span class="p">,</span> <span class="n">DescriptorsCalculator</span>
<span class="kn">from</span> <span class="nn">qsprpred.data.utils.feature_standardization</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SKLearnStandardizer</span><span class="p">,</span>
    <span class="n">apply_feature_standardizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">qsprpred.data.utils.folds</span> <span class="kn">import</span> <span class="n">Folds</span>
<span class="kn">from</span> <span class="nn">qsprpred.data.utils.scaffolds</span> <span class="kn">import</span> <span class="n">Scaffold</span>
<span class="kn">from</span> <span class="nn">qsprpred.data.utils.smiles_standardization</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">chembl_smi_standardizer</span><span class="p">,</span>
    <span class="n">old_standardize_sanitize</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">qsprpred.logs</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">qsprpred.models.tasks</span> <span class="kn">import</span> <span class="n">ModelTasks</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">PandasTools</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>


<div class="viewcode-block" id="MoleculeTable"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable">[docs]</a><span class="k">class</span> <span class="nc">MoleculeTable</span><span class="p">(</span><span class="n">MoleculeDataSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that holds and prepares molecule data for modelling and other analyses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MoleculeTable.ParallelApplyWrapper"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.ParallelApplyWrapper">[docs]</a>    <span class="k">class</span> <span class="nc">ParallelApplyWrapper</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper class to parallelize pandas apply functions.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            Initialize the instance with pandas parameters to apply to chunks of data.</span>

<span class="sd">            See `pandas.DataFrame.apply` for more information.</span>

<span class="sd">            Args:</span>
<span class="sd">                func: function to apply</span>
<span class="sd">                func_args: arguments to pass to func</span>
<span class="sd">                func_kwargs: keyword arguments to pass to func</span>
<span class="sd">                axis: axis to apply func on (0 for columns, 1 for rows)</span>
<span class="sd">                raw: whether to pass Series object to func or raw array</span>
<span class="sd">                result_type: whether to expand/ignore the results. See pandas.DataFrame.apply for more info.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">func_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">func_kwargs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_type</span> <span class="o">=</span> <span class="n">result_type</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Apply the function to the current chunk of data.</span>

<span class="sd">            Args:</span>
<span class="sd">                data: chunk of data to apply function to</span>

<span class="sd">            Returns:</span>
<span class="sd">                result of applying function to chunk of data</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_type</span><span class="p">,</span>
                              <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="k">else</span> <span class="p">{})</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">smilescol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SMILES&quot;</span><span class="p">,</span>
            <span class="n">add_rdkit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">store_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">drop_invalids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Initialize a `MoleculeTable` object. This object wraps a pandas dataframe and provides short-hand methods to prepare molecule</span>
<span class="sd">        data for modelling and analysis.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the dataset. You can use this name to load the dataset from disk anytime and create a new instance.</span>
<span class="sd">            df (pd.DataFrame): Pandas dataframe containing the data. If you provide a dataframe for a dataset that already exists on disk,</span>
<span class="sd">            the dataframe from disk will override the supplied data frame. Set &#39;overwrite&#39; to `True` to override the data frame on disk.</span>
<span class="sd">            smilescol (str): Name of the column containing the SMILES sequences of molecules.</span>
<span class="sd">            add_rdkit (bool): Add RDKit molecule instances to the dataframe. WARNING: This can take a lot of memory.</span>
<span class="sd">            store_dir (str): Directory to store the dataset files. Defaults to the current directory. If it already contains files with the same name, the existing data will be loaded.</span>
<span class="sd">            overwrite (bool): Overwrite existing dataset.</span>
<span class="sd">            n_jobs (int): Number of jobs to use for parallel processing. If &lt;= 0, all available cores will be used.</span>
<span class="sd">            chunk_size (int): Size of chunks to use per job in parallel processing.</span>
<span class="sd">            drop_invalids (bool): Drop invalid molecules from the data frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span> <span class="o">=</span> <span class="n">smilescol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">includesRdkit</span> <span class="o">=</span> <span class="n">add_rdkit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nJobs</span> <span class="o">=</span> <span class="n">n_jobs</span> <span class="k">if</span> <span class="n">n_jobs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunkSize</span> <span class="o">=</span> <span class="n">chunk_size</span>

        <span class="c1"># paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storeDir</span> <span class="o">=</span> <span class="n">store_dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storeDir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculatorPath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="si">}</span><span class="s2">_feature_calculators.json&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storeDir</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storeDir</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storePath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="si">}</span><span class="s1">_df.pkl&#39;</span>

        <span class="c1"># data frame initialization</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isInStore</span><span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Existing data set found, but also found a data frame in store. Refusing to overwrite data. If you want to overwrite data in store, set overwrite=True.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clearFiles</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">includesRdkit</span><span class="p">:</span>
                    <span class="n">PandasTools</span><span class="o">.</span><span class="n">AddMoleculeColumnToFrame</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">smilesCol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">,</span> <span class="n">molCol</span><span class="o">=</span><span class="s1">&#39;RDMol&#39;</span><span class="p">,</span> <span class="n">includeFingerprints</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isInStore</span><span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No data frame found in store for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. Are you sure this is the correct dataset? If you are creating a new data set, make sure to supply a data frame.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

        <span class="c1"># drop invalid columns</span>
        <span class="k">if</span> <span class="n">drop_invalids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropInvalids</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            int: Number of molecules in the data set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

<div class="viewcode-block" id="MoleculeTable.getDF"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getDF">[docs]</a>    <span class="k">def</span> <span class="nf">getDF</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: The data frame this instance manages.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span></div>

    <span class="k">def</span> <span class="nf">_isInStore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a pickled file with the given suffix exists.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Suffix of the file to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: `True` if the file exists, `False` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storePath</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">storePath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="MoleculeTable.save"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the data frame to disk and all associated files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Path to the saved data frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># save data frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storePath</span><span class="p">)</span>

        <span class="c1"># save descriptor calculator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span><span class="o">.</span><span class="n">toFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculatorPath</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">storePath</span></div>

<div class="viewcode-block" id="MoleculeTable.clearFiles"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.clearFiles">[docs]</a>    <span class="k">def</span> <span class="nf">clearFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all files associated with this data set from disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storeDir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pkl&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storeDir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.reload"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.reload">[docs]</a>    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reload the data table from disk.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storePath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculatorPath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span> <span class="o">=</span> <span class="n">DescriptorsCalculator</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculatorPath</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.fromFile"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.fromFile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MoleculeTable&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `MoleculeTable` instance from by providing a direct path to the pickled data frame in storage.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">MoleculeTable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">store_dir</span><span class="o">=</span><span class="n">store_dir</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.fromSMILES"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.fromSMILES">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromSMILES</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `MoleculeTable` instance from a list of SMILES sequences.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the data set.</span>
<span class="sd">            smiles (list): List of SMILES sequences.</span>
<span class="sd">            *args: Additional arguments to pass to the `MoleculeTable` constructor.</span>
<span class="sd">            **kwargs: Additional keyword arguments to pass to the `MoleculeTable` constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">smilescol</span> <span class="o">=</span> <span class="s2">&quot;SMILES&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">smilescol</span><span class="p">:</span> <span class="n">smiles</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">MoleculeTable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">smilescol</span><span class="o">=</span><span class="n">smilescol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.fromTableFile"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.fromTableFile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromTableFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `MoleculeTable` instance from a file containing a table of molecules (i.e. a CSV file).</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the data set.</span>
<span class="sd">            filename (str): Path to the file containing the table.</span>
<span class="sd">            sep (str): Separator used in the file for different columns.</span>
<span class="sd">            *args: Additional arguments to pass to the `MoleculeTable` constructor.</span>
<span class="sd">            **kwargs: Additional keyword arguments to pass to the `MoleculeTable` constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MoleculeTable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.fromSDF"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.fromSDF">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromSDF</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">smiles_prop</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a `MoleculeTable` instance from an SDF file.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the data set.</span>
<span class="sd">            filename (str): Path to the SDF file.</span>
<span class="sd">            smiles_prop (str): Name of the property in the SDF file containing the SMILES sequence.</span>
<span class="sd">            *args: Additional arguments to pass to the `MoleculeTable` constructor.</span>
<span class="sd">            **kwargs: Additional keyword arguments to pass to the `MoleculeTable` constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">MoleculeTable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">PandasTools</span><span class="o">.</span><span class="n">LoadSDF</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">molColName</span><span class="o">=</span><span class="s2">&quot;RDMol&quot;</span><span class="p">),</span> <span class="n">smilescol</span><span class="o">=</span><span class="n">smiles_prop</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span>
                             <span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># FIXME: in this case the RDKit molecule is always added, which can in most cases is an unnecessary overhead</span></div>

<div class="viewcode-block" id="MoleculeTable.getSubset"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getSubset">[docs]</a>    <span class="k">def</span> <span class="nf">getSubset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a subset of the data set by providing a prefix for the column names or a column name directly.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix (str): Prefix of the column names to select.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]]</span></div>

<div class="viewcode-block" id="MoleculeTable.apply"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a function to the data frame. In addition to the arguments of `pandas.DataFrame.apply`, this method also</span>
<span class="sd">        supports parallelization using `multiprocessing.Pool`.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (callable): Function to apply to the data frame.</span>
<span class="sd">            func_args (list): Positional arguments to pass to the function.</span>
<span class="sd">            func_kwargs (dict): Keyword arguments to pass to the function.</span>
<span class="sd">            axis (int): Axis along which the function is applied (0 for column, 1 for rows).</span>
<span class="sd">            raw (bool): Whether to pass the data frame as-is to the function or to pass each row/column as a Series to the function.</span>
<span class="sd">            result_type (str): Whether to expand the result of the function to columns or to leave it as a Series.</span>
<span class="sd">            subset (list): List of column names if only a subset of the data should be used (reduces memory consumption).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nJobs</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunkSize</span>
        <span class="k">if</span> <span class="n">n_cpus</span> <span class="ow">and</span> <span class="n">n_cpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">papply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func_args</span><span class="p">,</span> <span class="n">func_kwargs</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">raw</span><span class="p">,</span> <span class="n">result_type</span><span class="p">,</span> <span class="n">subset</span><span class="p">,</span> <span class="n">n_cpus</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">subset</span> <span class="k">if</span> <span class="n">subset</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="n">result_type</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="n">func_args</span><span class="p">,</span> <span class="o">**</span><span class="n">func_kwargs</span> <span class="k">if</span> <span class="n">func_kwargs</span> <span class="k">else</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="MoleculeTable.papply"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.papply">[docs]</a>    <span class="k">def</span> <span class="nf">papply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">func_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parallelized version of `MoleculeTable.apply`.</span>

<span class="sd">        Args:</span>
<span class="sd">            func (callable): Function to apply to the data frame.</span>
<span class="sd">            func_args (list): Positional arguments to pass to the function.</span>
<span class="sd">            func_kwargs (dict): Keyword arguments to pass to the function.</span>
<span class="sd">            axis (int): Axis along which the function is applied (0 for column, 1 for rows).</span>
<span class="sd">            raw (bool): Whether to pass the data frame as-is to the function or to pass each row/column as a Series to the function.</span>
<span class="sd">            result_type (str): Whether to expand the result of the function to columns or to leave it as a Series.</span>
<span class="sd">            subset (list): List of column names if only a subset of the data should be used (reduces memory consumption).</span>
<span class="sd">            n_cpus (int): Number of CPUs to use for parallelization.</span>
<span class="sd">            chunk_size (int): Number of rows to process in each chunk.</span>
<span class="sd">            n_cpus (int): Number of CPUs to use for parallelization.</span>
<span class="sd">            chunk_size (int): Number of rows to process in each chunk.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">n_cpus</span> <span class="o">=</span> <span class="n">n_cpus</span> <span class="k">if</span> <span class="n">n_cpus</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="n">df_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">subset</span> <span class="k">if</span> <span class="n">subset</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_sub</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">)]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_cpus</span>  <span class="c1"># how many batches to prefetch into the process (more is faster, but uses more memory)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">n_cpus</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">batches</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Parallel apply in progress for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">):</span>
                <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ParallelApplyWrapper</span><span class="p">(</span>
                    <span class="n">func</span><span class="p">,</span>
                    <span class="n">func_args</span><span class="o">=</span><span class="n">func_args</span><span class="p">,</span>
                    <span class="n">func_kwargs</span><span class="o">=</span><span class="n">func_kwargs</span><span class="p">,</span>
                    <span class="n">result_type</span><span class="o">=</span><span class="n">result_type</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                    <span class="n">raw</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.transform"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">transformer</span><span class="p">,</span> <span class="n">addAs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the data frame (or its part) using a list of transformers. Each transformer is a function that takes the data frame</span>
<span class="sd">        (or a subset of it as defined by the `targets` argument) and returns a transformed data frame. The transformed</span>
<span class="sd">        data frame can then be added to the original data frame if `addAs` is set to a `list` of new column names. If</span>
<span class="sd">        `addAs` is not `None`, the result of the application of transformers must have the same number of rows as the</span>
<span class="sd">        original data frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            targets (list): List of column names to transform.</span>
<span class="sd">            transformer (callable): Function that transforms the data in target columns to a new representation.</span>
<span class="sd">            addAs (list): If `True`, the transformed data is added to the original data frame and the</span>
<span class="sd">            names in this list are used as column names for the new data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">targets</span><span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">addAs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">addAs</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="MoleculeTable.filter"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_filters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter the data frame using a list of filters. Each filter is a function that takes the data frame and returns a</span>
<span class="sd">        a new data frame with the filtered rows. The new data frame is then used as the input for the next filter. The</span>
<span class="sd">        final data frame is saved as the new data frame of the `MoleculeTable`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_filtered</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">table_filter</span> <span class="ow">in</span> <span class="n">table_filters</span><span class="p">:</span>
            <span class="n">df_filtered</span> <span class="o">=</span> <span class="n">table_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">df_filtered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="MoleculeTable.addDescriptors"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.addDescriptors">[docs]</a>    <span class="k">def</span> <span class="nf">addDescriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calculator</span><span class="p">:</span> <span class="n">Calculator</span><span class="p">,</span> <span class="n">recalculate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add descriptors to the data frame using a `Calculator` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            calculator (Calculator): Calculator object to use for descriptor calculation.</span>
<span class="sd">            recalculate (bool): Whether to recalculate descriptors even if they are already present in the data frame.</span>
<span class="sd">                If `False`, existing descriptors are kept and no calculation takes place.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">recalculate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDescriptorNames</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Descriptors already exist in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. Use `recalculate=True` to overwrite them.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">calculator</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">],</span>
            <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;reduce&#39;</span>
        <span class="p">)</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">descriptors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">descriptors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">descriptors</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">descriptors</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span> <span class="o">=</span> <span class="n">calculator</span></div>

<div class="viewcode-block" id="MoleculeTable.getDescriptors"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getDescriptors">[docs]</a>    <span class="k">def</span> <span class="nf">getDescriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the subset of the data frame that contains only descriptors.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Data frame containing only descriptors.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getDescriptorNames</span><span class="p">()]</span></div>

<div class="viewcode-block" id="MoleculeTable.getDescriptorNames"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getDescriptorNames">[docs]</a>    <span class="k">def</span> <span class="nf">getDescriptorNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the names of the descriptors in the data frame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of descriptor names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Descriptor_&quot;</span><span class="p">)]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasDescriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the data frame contains descriptors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDescriptorNames</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="MoleculeTable.getProperties"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getProperties">[docs]</a>    <span class="k">def</span> <span class="nf">getProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get names of all properties/variables saved in the data frame (all columns).</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of property names.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span></div>

<div class="viewcode-block" id="MoleculeTable.hasProperty"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.hasProperty">[docs]</a>    <span class="k">def</span> <span class="nf">hasProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether a property is present in the data frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the property.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the property is present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span></div>

<div class="viewcode-block" id="MoleculeTable.addProperty"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.addProperty">[docs]</a>    <span class="k">def</span> <span class="nf">addProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a property to the data frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the property.</span>
<span class="sd">            data (list): List of property values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="MoleculeTable.removeProperty"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.removeProperty">[docs]</a>    <span class="k">def</span> <span class="nf">removeProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a property from the data frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): Name of the property to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_scaffold_calculator</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">scaffold</span><span class="p">:</span> <span class="n">Scaffold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Just a helper function to calculate the scaffold of a molecule more easily.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">scaffold</span><span class="p">(</span><span class="n">mol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<div class="viewcode-block" id="MoleculeTable.addScaffolds"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.addScaffolds">[docs]</a>    <span class="k">def</span> <span class="nf">addScaffolds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaffolds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Scaffold</span><span class="p">],</span> <span class="n">add_rdkit_scaffold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recalculate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add scaffolds to the data frame. A new column is created that contains the SMILES of the corresponding scaffold.</span>
<span class="sd">        If `add_rdkit_scaffold` is set to `True`, a new column is created that contains the RDKit scaffold of the</span>
<span class="sd">        corresponding molecule.</span>

<span class="sd">        Args:</span>
<span class="sd">            scaffolds (list): List of `Scaffold` calculators.</span>
<span class="sd">            add_rdkit_scaffold (bool): Whether to add the RDKit scaffold of the molecule as a new column.</span>
<span class="sd">            recalculate (bool): Whether to recalculate scaffolds even if they are already present in the data frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">scaffold</span> <span class="ow">in</span> <span class="n">scaffolds</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recalculate</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;Scaffold_</span><span class="si">{</span><span class="n">scaffold</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Scaffold_</span><span class="si">{</span><span class="n">scaffold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scaffold_calculator</span><span class="p">,</span> <span class="n">func_args</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">scaffold</span><span class="p">,),</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_rdkit_scaffold</span><span class="p">:</span>
                <span class="n">PandasTools</span><span class="o">.</span><span class="n">AddMoleculeColumnToFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">smilesCol</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Scaffold_</span><span class="si">{</span><span class="n">scaffold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                                     <span class="n">molCol</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Scaffold_</span><span class="si">{</span><span class="n">scaffold</span><span class="si">}</span><span class="s2">_RDMol&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.getScaffoldNames"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getScaffoldNames">[docs]</a>    <span class="k">def</span> <span class="nf">getScaffoldNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_mols</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the names of the scaffolds in the data frame.</span>

<span class="sd">        Args:</span>
<span class="sd">            include_mols (bool): Whether to include the RDKit scaffold columns as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Scaffold_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">include_mols</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_RDMol&quot;</span><span class="p">))]</span></div>

<div class="viewcode-block" id="MoleculeTable.getScaffolds"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getScaffolds">[docs]</a>    <span class="k">def</span> <span class="nf">getScaffolds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">includeMols</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the subset of the data frame that contains only scaffolds.</span>

<span class="sd">        Args:</span>
<span class="sd">            includeMols (bool): Whether to include the RDKit scaffold columns as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">includeMols</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Scaffold_&quot;</span><span class="p">)]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getScaffoldNames</span><span class="p">()]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasScaffolds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the data frame contains scaffolds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the data frame contains scaffolds.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getScaffoldNames</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="MoleculeTable.createScaffoldGroups"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.createScaffoldGroups">[docs]</a>    <span class="k">def</span> <span class="nf">createScaffoldGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mols_per_group</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create scaffold groups. A scaffold group is a list of molecules that share the same scaffold. New columns are</span>
<span class="sd">        created that contain the scaffold group ID and the scaffold group size.</span>

<span class="sd">        Args:</span>
<span class="sd">            mols_per_group (int): Number of molecules per scaffold group.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">scaffolds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getScaffolds</span><span class="p">(</span><span class="n">includeMols</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scaffold</span> <span class="ow">in</span> <span class="n">scaffolds</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">scaffold</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">mols_per_group</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ScaffoldGroup_</span><span class="si">{</span><span class="n">scaffold</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mols_per_group</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">scaffold</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="s1">&#39;Other&#39;</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">scaffold</span><span class="p">])</span></div>

<div class="viewcode-block" id="MoleculeTable.getScaffoldGroups"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.getScaffoldGroups">[docs]</a>    <span class="k">def</span> <span class="nf">getScaffoldGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaffold_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mol_per_group</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the scaffold groups for a given combination of scaffold and number of molecules per scaffold group.</span>

<span class="sd">        Args:</span>
<span class="sd">            scaffold_name (str): Name of the scaffold.</span>
<span class="sd">            mol_per_group (int): Number of molecules per scaffold group.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of scaffold groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ScaffoldGroup_</span><span class="si">{</span><span class="n">scaffold_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mol_per_group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasScaffoldGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the data frame contains scaffold groups.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether the data frame contains scaffold groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ScaffoldGroup_&quot;</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="MoleculeTable.standardizeSmiles"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.standardizeSmiles">[docs]</a>    <span class="k">def</span> <span class="nf">standardizeSmiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smiles_standardizer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply smiles_standardizer to the compounds in parallel</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles_standardizer (Union[str, callable]): either `None` to skip the standardization,</span>
<span class="sd">                `chembl`, `old`, or a partial function that reads and standardizes smiles.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: when smiles_standardizer is not a callable or one of the predefined strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">std_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nJobs</span>
        <span class="k">if</span> <span class="n">smiles_standardizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">smiles_standardizer</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span> <span class="c1"># Prevents weird error if the user inputs a lambda function</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">smiles_standardizer</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Standardizer is not pickleable. Will set n_jobs to 1&quot;</span><span class="p">)</span>
                <span class="n">std_jobs</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">std_func</span> <span class="o">=</span> <span class="n">smiles_standardizer</span>
        <span class="k">elif</span> <span class="n">smiles_standardizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chembl&#39;</span><span class="p">:</span>
            <span class="n">std_func</span> <span class="o">=</span> <span class="n">chembl_smi_standardizer</span>
        <span class="k">elif</span> <span class="n">smiles_standardizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;old&#39;</span><span class="p">:</span>
            <span class="n">std_func</span> <span class="o">=</span> <span class="n">old_standardize_sanitize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Standardizer must be either &#39;chembl&#39;, or a callable&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">std_jobs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">std_smi</span> <span class="o">=</span> <span class="p">[</span><span class="n">std_func</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">std_jobs</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">std_smi</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">std_func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_smi</span></div>

<div class="viewcode-block" id="MoleculeTable.shuffle"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.shuffle">[docs]</a>    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuffle the internal data frame.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeTable.dropInvalids"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.MoleculeTable.dropInvalids">[docs]</a>    <span class="k">def</span> <span class="nf">dropInvalids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop Invalid SMILES.&quot;&quot;&quot;</span>

        <span class="n">invalid_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">smile</span><span class="p">:</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smile</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Removing invalid SMILES: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">][</span><span class="n">invalid_mask</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">invalid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">invalid_mask</span></div></div>


<div class="viewcode-block" id="QSPRDataset"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset">[docs]</a><span class="k">class</span> <span class="nc">QSPRDataset</span><span class="p">(</span><span class="n">MoleculeTable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare dataset for QSPR model training.</span>

<span class="sd">    It splits the data in train and test set, as well as creating cross-validation folds.</span>
<span class="sd">    Optionally low quality data is filtered out.</span>
<span class="sd">    For classification the dataset samples are labelled as active/inactive.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        targetProperty (str) : property to be predicted with QSPRmodel</span>
<span class="sd">        task (ModelTask) : regression or classification</span>
<span class="sd">        df (pd.dataframe) : dataset</span>
<span class="sd">        X (np.ndarray/pd.DataFrame) : m x n feature matrix for cross validation, where m is</span>
<span class="sd">            the number of samplesand n is the number of features.</span>
<span class="sd">        y (np.ndarray/pd.DataFrame) : m-d label array for cross validation, where m is the</span>
<span class="sd">            number of samples and equals to row of X.</span>
<span class="sd">        X_ind (np.ndarray/pd.DataFrame) : m x n Feature matrix for independent set, where m</span>
<span class="sd">            is the number of samples and n is the number of features.</span>
<span class="sd">        y_ind (np.ndarray/pd.DataFrame) : m-l label array for independent set, where m is</span>
<span class="sd">            the number of samples and equals to row of X_ind, and l is the number of types.</span>
<span class="sd">        featureNames (list of str) : feature names</span>
<span class="sd">        feature_standardizers (list of FeatureStandardizers): methods used to standardize the data features.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target_prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">smilescol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SMILES&quot;</span><span class="p">,</span>
        <span class="n">add_rdkit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">store_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="n">ModelTasks</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">REGRESSION</span><span class="p">,</span>
        <span class="n">target_transformer</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">th</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">drop_invalids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">drop_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct QSPRdata, also apply transformations of output property if specified.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): data name, used in saving the data</span>
<span class="sd">            target_prop (str): target property, should correspond with target columnname in df</span>
<span class="sd">            df (pd.DataFrame, optional): input dataframe containing smiles and target property. Defaults to None.</span>
<span class="sd">            smilescol (str, optional): name of column in df containing SMILES. Defaults to &quot;SMILES&quot;.</span>
<span class="sd">            add_rdkit (bool, optional): if true, column with rdkit molecules will be added to df. Defaults to False.</span>
<span class="sd">            store_dir (str, optional): directory for saving the output data. Defaults to &#39;.&#39;.</span>
<span class="sd">            overwrite (bool, optional): if already saved data at output dir if should be overwritten. Defaults to False.</span>
<span class="sd">            task (Literal[ModelTasks.REGRESSION, ModelTasks.CLASSIFICATION], optional): Defaults to ModelTasks.REGRESSION.</span>
<span class="sd">            target_transformer (Callable, optional): Transformation(s) of target property. Defaults to None.</span>
<span class="sd">            th (List[float], optional): threshold for activity if classification model, if len th</span>
<span class="sd">                larger than 1, these values will used for binning (in this case lower and upper</span>
<span class="sd">                boundary need to be included). Defaults to None.</span>
<span class="sd">            n_jobs (int, optional): number of parallel jobs. If &lt;= 0, all available cores will be used. Defaults to 1.</span>
<span class="sd">            chunk_size (int, optional): chunk size for parallel processing. Defaults to 50.</span>
<span class="sd">            drop_invalids (bool, optional): if true, invalid SMILES will be dropped. Defaults to True.</span>
<span class="sd">            drop_empty (bool, optional): if true, rows with empty target property will be removed.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: Raised if thershold given with non-classification task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">smilescol</span><span class="p">,</span> <span class="n">add_rdkit</span><span class="p">,</span> <span class="n">store_dir</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">drop_invalids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span> <span class="o">=</span> <span class="n">target_prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span> <span class="o">=</span> <span class="n">target_prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span> <span class="o">=</span> <span class="n">QSPRDataset</span><span class="o">.</span><span class="n">loadMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">store_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">target_transformer</span><span class="p">:</span>
            <span class="n">transformed_prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="si">}</span><span class="s1">_transformed&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">],</span> <span class="n">target_transformer</span><span class="p">,</span> <span class="n">addAs</span><span class="o">=</span><span class="p">[</span><span class="n">transformed_prop</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="si">}</span><span class="s1">_transformed&#39;</span>

        <span class="c1"># load names of descriptors to use as training features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFeatureNames</span><span class="p">()</span>

        <span class="c1"># load standardizers for features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadFeatureStandardizer</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFoldGenerator</span><span class="p">()</span>

        <span class="c1"># drop rows with empty target property value</span>
        <span class="k">if</span> <span class="n">drop_empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dropEmpty</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">th</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">==</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">th</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">makeClassification</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if a precomputed target is expected, just check it</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span>
                <span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]),</span> <span class="sa">f</span><span class="s2">&quot;Target property (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="si">}</span><span class="s2">) should be integer if used for classification. Or specify threshold for binning.&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">==</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">REGRESSION</span> <span class="ow">and</span> <span class="n">th</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Got regression task with specified thresholds: &#39;th=</span><span class="si">{</span><span class="n">th</span><span class="si">}</span><span class="s2">&#39;. Use &#39;task=ModelType.CLASSIFICATION&#39; in this case.&quot;</span><span class="p">)</span>

        <span class="c1"># populate feature matrix and target property array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restoreTrainingData</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created for target targetProperty: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="QSPRDataset.fromTableFile"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.fromTableFile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromTableFile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create QSPRDataset from table file (i.e. CSV or TSV).</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): name of the data set</span>
<span class="sd">            filename (str): path to the table file</span>
<span class="sd">            sep (str, optional): separator in the table file. Defaults to &quot;\t&quot;.</span>
<span class="sd">            *args: additional arguments for QSPRDataset constructor</span>
<span class="sd">            **kwargs: additional keyword arguments for QSPRDataset constructor</span>
<span class="sd">        Returns:</span>
<span class="sd">            QSPRDataset: `QSPRDataset` object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">QSPRDataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.fromSDF"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.fromSDF">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromSDF</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">smiles_prop</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create QSPRDataset from SDF file. It is currently not implemented for QSPRDataset, but you can convert</span>
<span class="sd">        from &#39;MoleculeTable&#39; with the &#39;fromMolTable&#39; method.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): name of the data set</span>
<span class="sd">            filename (str): path to the SDF file</span>
<span class="sd">            smiles_prop (str): name of the property in the SDF file containing SMILES</span>
<span class="sd">            *args: additional arguments for QSPRDataset constructor</span>
<span class="sd">            **kwargs: additional keyword arguments for QSPRDataset constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SDF loading not implemented for </span><span class="si">{</span><span class="n">QSPRDataset</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, yet. You can convert from &#39;MoleculeTable&#39; with &#39;fromMolTable&#39;.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.dropEmpty"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.dropEmpty">[docs]</a>    <span class="k">def</span> <span class="nf">dropEmpty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop rows with empty target property value from the data set.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hasFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the currently selected set of features is not empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="QSPRDataset.getFeatureNames"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.getFeatureNames">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatureNames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current feature names for this data set.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[str]: list of feature names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescriptorNames</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">descset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span><span class="o">.</span><span class="n">descsets</span><span class="p">:</span>
                <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">descset</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">descset</span><span class="o">.</span><span class="n">descriptors</span><span class="p">])</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Descriptor_</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;feature_names&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span><span class="p">[</span><span class="s1">&#39;feature_names&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">features</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span><span class="p">[</span><span class="s1">&#39;feature_names&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="QSPRDataset.restoreTrainingData"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.restoreTrainingData">[docs]</a>    <span class="k">def</span> <span class="nf">restoreTrainingData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore training data from the data frame. If the data frame contains a column &#39;Split_IsTrain&#39;,</span>
<span class="sd">        the data will be split into training and independent sets. Otherwise, the independent set will</span>
<span class="sd">        be empty. If descriptors are available, the resulting training matrices will be featurized.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadDataToSplits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurizeSplits</span><span class="p">()</span></div>

<div class="viewcode-block" id="QSPRDataset.isMultiClass"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.isMultiClass">[docs]</a>    <span class="k">def</span> <span class="nf">isMultiClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return if model task is multi class classification.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">==</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nClasses</span> <span class="o">&gt;</span> <span class="mi">2</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nClasses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of output classes for classification.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">==</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="QSPRDataset.makeRegression"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.makeRegression">[docs]</a>    <span class="k">def</span> <span class="nf">makeRegression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_property</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to regression task using the given target property.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_property (str): name of the target property to use for regression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">th</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">REGRESSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span> <span class="o">=</span> <span class="n">target_property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span> <span class="o">=</span> <span class="n">target_property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restoreTrainingData</span><span class="p">()</span></div>

<div class="viewcode-block" id="QSPRDataset.makeClassification"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.makeClassification">[docs]</a>    <span class="k">def</span> <span class="nf">makeClassification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">th</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch to classification task using the given threshold values.</span>

<span class="sd">        Args:</span>
<span class="sd">            th (List[float], optional): list of threshold values. Defaults to tuple().</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span><span class="si">}</span><span class="s2">_class&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Threshold list must contain at least one value.&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">th</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span>
            <span class="p">),</span> <span class="s2">&quot;For multi-class classification, set more than 3 values as threshold.&quot;</span>
            <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">th</span>
            <span class="p">),</span> <span class="s2">&quot;Make sure final threshold value is not smaller than largest value of property&quot;</span>
            <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="n">th</span>
            <span class="p">),</span> <span class="s2">&quot;Make sure first threshold value is not larger than smallest value of property&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_prop</span><span class="si">}</span><span class="s2">_intervals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">th</span><span class="p">,</span> <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">new_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_prop</span><span class="si">}</span><span class="s2">_intervals&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">new_prop</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span> <span class="o">=</span> <span class="n">new_prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">th</span> <span class="o">=</span> <span class="n">th</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restoreTrainingData</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Target property converted to classification.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.loadMetadata"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.loadMetadata">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">loadMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">store_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load metadata from a JSON file.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str): name of the data set</span>
<span class="sd">            store_dir (str): directory where the data set is stored</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_meta.json&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelTasks</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">meta</span></div>

<div class="viewcode-block" id="QSPRDataset.fromFile"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.fromFile">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;QSPRDataset&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load QSPRDataset from the saved file directly.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): path to the saved file</span>
<span class="sd">            args: additional arguments to pass to the constructor</span>
<span class="sd">            kwargs: additional keyword arguments to pass to the constructor</span>

<span class="sd">        Returns:</span>
<span class="sd">            QSPRDataset: loaded data set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">QSPRDataset</span><span class="o">.</span><span class="n">loadMetadata</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">store_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">QSPRDataset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">store_dir</span><span class="o">=</span><span class="n">store_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.fromMolTable"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.fromMolTable">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromMolTable</span><span class="p">(</span><span class="n">mol_table</span><span class="p">:</span> <span class="n">MoleculeTable</span><span class="p">,</span> <span class="n">target_prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;QSPRDataset&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create QSPRDataset from a MoleculeTable.</span>

<span class="sd">        Args:</span>
<span class="sd">            mol_table (MoleculeTable): MoleculeTable to use as the data source</span>
<span class="sd">            target_prop (str): name of the target property</span>
<span class="sd">            name (str, optional): name of the data set. Defaults to None.</span>
<span class="sd">            kwargs: additional keyword arguments to pass to the constructor</span>

<span class="sd">        Returns:</span>
<span class="sd">            QSPRDataset: created data set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;store_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_table</span><span class="o">.</span><span class="n">storeDir</span> <span class="k">if</span> <span class="s1">&#39;store_dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;store_dir&#39;</span><span class="p">]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">mol_table</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">QSPRDataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">target_prop</span><span class="p">,</span> <span class="n">mol_table</span><span class="o">.</span><span class="n">getDF</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.addDescriptors"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.addDescriptors">[docs]</a>    <span class="k">def</span> <span class="nf">addDescriptors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calculator</span><span class="p">:</span> <span class="n">Calculator</span><span class="p">,</span> <span class="n">recalculate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">featurize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add descriptors to the data set. If descriptors are already present, they will be recalculated if `recalculate` is `True`.</span>
<span class="sd">        Featurization will be performed after adding descriptors if `featurize` is `True`. Featurazation</span>
<span class="sd">        converts current data matrices to pure numeric matrices of selected descriptors (features).</span>

<span class="sd">        Args:</span>
<span class="sd">            calculator (Calculator): calculator instance to use for descriptor calculation</span>
<span class="sd">            recalculate (bool, optional): whether to recalculate descriptors if they are already present. Defaults to `False`.</span>
<span class="sd">            featurize (bool, optional): whether to featurize the data set after adding descriptors. Defaults to `True`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">addDescriptors</span><span class="p">(</span><span class="n">calculator</span><span class="p">,</span> <span class="n">recalculate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFeatureNames</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">featurize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurizeSplits</span><span class="p">()</span></div>

<div class="viewcode-block" id="QSPRDataset.saveSplit"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.saveSplit">[docs]</a>    <span class="k">def</span> <span class="nf">saveSplit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save split data to the managed data frame.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Split_IsTrain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No split data available. Skipping split data save.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.save"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_split</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the data set to file and serialize metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">save_split</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveSplit</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># save metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveMetadata</span><span class="p">()</span></div>

<div class="viewcode-block" id="QSPRDataset.split"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="n">datasplit</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split dataset into train and test set.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (datasplit) : split instance orchestrating the split</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="s2">&quot;hasDataSet&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="s2">&quot;setDataSet&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">split</span><span class="o">.</span><span class="n">hasDataSet</span><span class="p">:</span>
            <span class="n">split</span><span class="o">.</span><span class="n">setDataSet</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">folds</span> <span class="o">=</span> <span class="n">Folds</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">,</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">folds</span><span class="o">.</span><span class="n">iterFolds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_index</span><span class="p">,</span> <span class="p">:][</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test_index</span><span class="p">,</span> <span class="p">:][</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Total: train: </span><span class="si">%s</span><span class="s2"> test: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">)))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">==</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMultiClass</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;    In train: active: </span><span class="si">%s</span><span class="s2"> not active: </span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;    In test:  active: </span><span class="si">%s</span><span class="s2"> not active: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;train: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;test: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()])</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()])</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                        <span class="s2">&quot;All bins in multi-class classification should contain at least one sample&quot;</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span></div>

<div class="viewcode-block" id="QSPRDataset.loadDataToSplits"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.loadDataToSplits">[docs]</a>    <span class="k">def</span> <span class="nf">loadDataToSplits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the data frame into the train and test splits if the information is available. Otherwise, the whole data</span>
<span class="sd">        set will be regarded as the training set and the test set will have zero length.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]]</span>

        <span class="c1"># split data into training and independent sets if saved previously</span>
        <span class="k">if</span> <span class="s2">&quot;Split_IsTrain&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Split_IsTrain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Split_IsTrain&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>
<div class="viewcode-block" id="QSPRDataset.loadDescriptorsToSplits"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.loadDescriptorsToSplits">[docs]</a>    <span class="k">def</span> <span class="nf">loadDescriptorsToSplits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads all available descriptors into the train and test splits. If no descriptors are available, an exception</span>
<span class="sd">        will be raised.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if no descriptors are available</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No descriptors available. Cannot load descriptors to splits.&quot;</span><span class="p">)</span>

        <span class="n">descriptors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescriptors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="n">descriptors</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">])</span></div>

<div class="viewcode-block" id="QSPRDataset.featurizeSplits"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.featurizeSplits">[docs]</a>    <span class="k">def</span> <span class="nf">featurizeSplits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the data set has descriptors, load them into the train and test splits.</span>

<span class="sd">        If no descriptors are available, remove all features from</span>
<span class="sd">        the splits They will become zero length along the feature axis (columns), but will retain their original length</span>
<span class="sd">        along the sample axis (rows). This is useful for the case where the data set has no descriptors, but the user</span>
<span class="sd">        wants to retain train and test splits.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadDescriptorsToSplits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="QSPRDataset.fillMissing"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.fillMissing">[docs]</a>    <span class="k">def</span> <span class="nf">fillMissing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill missing values in the data set with a given value.</span>

<span class="sd">        Args:</span>
<span class="sd">            fill_value (float): value to fill missing values with</span>
<span class="sd">            columns (List[str], optional): columns to fill missing values in. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">columns</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescriptorNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Missing values filled with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fill_value</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.filterFeatures"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.filterFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">filterFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_filters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter features in the data set.</span>

<span class="sd">        Args:</span>
<span class="sd">            feature_filters (List[Callable]): list of feature filter functions that take X feature matrix and y target vector as arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasFeatures</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No features to filter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Only one feature present. Skipping feature filtering.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">featurefilter</span> <span class="ow">in</span> <span class="n">feature_filters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">featurefilter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected features: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># update descriptor calculator</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculator</span><span class="o">.</span><span class="n">keepDescriptors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.setFeatureStandardizer"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.setFeatureStandardizer">[docs]</a>    <span class="k">def</span> <span class="nf">setFeatureStandardizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_standardizer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set feature standardizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            feature_standardizer (Union[SKLearnStandardizer, BaseEstimator]): feature standardizer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">feature_standardizer</span><span class="p">,</span> <span class="s1">&#39;toFile&#39;</span><span class="p">):</span>
            <span class="n">feature_standardizer</span> <span class="o">=</span> <span class="n">SKLearnStandardizer</span><span class="p">(</span><span class="n">feature_standardizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span> <span class="o">=</span> <span class="n">feature_standardizer</span></div>

<div class="viewcode-block" id="QSPRDataset.prepareDataset"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.prepareDataset">[docs]</a>    <span class="k">def</span> <span class="nf">prepareDataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">smiles_standardizer</span><span class="o">=</span><span class="s1">&#39;chembl&#39;</span><span class="p">,</span>
        <span class="n">datafilters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">split</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_calculator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature_standardizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">recalculate_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the dataset for use in QSPR model.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            smiles_standardizer (Union[str, callable]): either `None` to skip the standardization,</span>
<span class="sd">                `chembl`, `old`, or a partial function that reads and standardizes smiles.</span>
<span class="sd">            datafilters (list of datafilter obj): filters number of rows from dataset</span>
<span class="sd">            split (datasplitter obj): splits the dataset into train and test set</span>
<span class="sd">            fold (datasplitter obj): splits the train set into folds for cross validation</span>
<span class="sd">            feature_calculator (Calculator): calculates features from smiles</span>
<span class="sd">            feature_filters (list of feature filter objs): filters features</span>
<span class="sd">            feature_standardizer (SKLearnStandardizer or sklearn.base.BaseEstimator): standardizes and/or scales features</span>
<span class="sd">            recalculate_features (bool): recalculate features even if they are already present in the file</span>
<span class="sd">            fill_value (float): value to fill missing values with, defaults to `numpy.nan`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># apply sanitization and standardization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standardizeSmiles</span><span class="p">(</span><span class="n">smiles_standardizer</span><span class="p">)</span>

        <span class="c1"># calculate featureNames</span>
        <span class="k">if</span> <span class="n">feature_calculator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addDescriptors</span><span class="p">(</span><span class="n">feature_calculator</span><span class="p">,</span> <span class="n">recalculate</span><span class="o">=</span><span class="n">recalculate_features</span><span class="p">,</span> <span class="n">featurize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># apply data filters</span>
        <span class="k">if</span> <span class="n">datafilters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">datafilters</span><span class="p">)</span>

        <span class="c1"># Replace any NaN values in featureNames by 0</span>
        <span class="c1"># FIXME: this is not very good, we should probably add option to do custom</span>
        <span class="c1"># data imputation here or drop rows with NaNs</span>
        <span class="k">if</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fillMissing</span><span class="p">(</span><span class="n">fill_value</span><span class="p">)</span>

        <span class="c1"># split dataset</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">]</span>

        <span class="c1"># featurize splits</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurizeSplits</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempting to featurize splits without descriptors. Skipping this step...&quot;</span><span class="p">)</span>

        <span class="c1"># apply feature filters on training set</span>
        <span class="k">if</span> <span class="n">feature_filters</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filterFeatures</span><span class="p">(</span><span class="n">feature_filters</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;No descriptors present, feature filters will be skipped.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># set feature standardizers</span>
        <span class="k">if</span> <span class="n">feature_standardizer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setFeatureStandardizer</span><span class="p">(</span><span class="n">feature_standardizer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span> <span class="o">=</span> <span class="n">Folds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span><span class="o">.</span><span class="n">split</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No descriptors present, feature standardizers were initialized, but might fail or have no effect.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># create fold generator</span>
        <span class="k">if</span> <span class="n">fold</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span> <span class="o">=</span> <span class="n">Folds</span><span class="p">(</span><span class="n">fold</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.getDefaultFoldSplit"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.getDefaultFoldSplit">[docs]</a>    <span class="k">def</span> <span class="nf">getDefaultFoldSplit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the default fold split for the model task.</span>

<span class="sd">        Returns:</span>
<span class="sd">            datasplit (datasplit): default fold split implementation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">!=</span> <span class="n">ModelTasks</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">KFold</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.getDefaultFoldGenerator"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.getDefaultFoldGenerator">[docs]</a>    <span class="k">def</span> <span class="nf">getDefaultFoldGenerator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the default fold generator. The fold generator is used to create folds for cross validation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Folds (Folds): default fold generator implementation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Folds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFoldSplit</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.checkFeatures"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.checkFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">checkFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No descriptors exist in the data set. Cannot create folds.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasFeatures</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No features exist in the data set. Cannot create folds.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;X and y have different number of rows: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X has no rows.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.createFolds"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.createFolds">[docs]</a>    <span class="k">def</span> <span class="nf">createFolds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="n">datasplit</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create folds for cross validation.</span>

<span class="sd">        Args:</span>
<span class="sd">            split (datasplit, optional): split to use for creating folds. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkFeatures</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDefaultFoldGenerator</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">split</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span> <span class="o">=</span> <span class="n">Folds</span><span class="p">(</span><span class="n">split</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_generator</span><span class="o">.</span><span class="n">iterFolds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span></div>

<div class="viewcode-block" id="QSPRDataset.fitFeatureStandardizer"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.fitFeatureStandardizer">[docs]</a>    <span class="k">def</span> <span class="nf">fitFeatureStandardizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the feature standardizers on the training set.</span>

<span class="sd">        Returns:</span>
<span class="sd">            X (pd.DataFrame): standardized training set</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDescriptors</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescriptors</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">apply_feature_standardizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="QSPRDataset.getFeatures"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.getFeatures">[docs]</a>    <span class="k">def</span> <span class="nf">getFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">concat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current feature sets (training and test) from the dataset.</span>
<span class="sd">        This method also applies any feature standardizers that have been set on the dataset during preparation.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            inplace (bool): If `True`, the created feature matrices will be saved to the dataset object itself as &#39;X&#39; and &#39;X_ind&#39; attributes. Note that this will overwrite any existing feature matrices and if the data preparation workflow changes, these are not kept up to date. Therefore, it is recommended to generate new feature sets after any data set changes.</span>
<span class="sd">            concat (bool): If `True`, the training and test feature matrices will be concatenated into a single matrix. This is useful for</span>
<span class="sd">                training models that do not require separate training and test sets (i.e. the final optimized models).</span>
<span class="sd">            raw (bool): If `True`, the raw feature matrices will be returned without any standardization applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkFeatures</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">concat</span><span class="p">:</span>
            <span class="n">df_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df_X_ind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]</span>
            <span class="n">df_X_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">]</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df_X</span><span class="o">.</span><span class="n">values</span>
        <span class="n">X_ind</span> <span class="o">=</span> <span class="n">df_X_ind</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">df_X_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span> <span class="o">=</span> <span class="n">apply_feature_standardizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">,</span>
                <span class="n">df_X</span><span class="p">,</span>
                <span class="n">fit</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">X_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">X_ind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">apply_feature_standardizer</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">,</span>
                    <span class="n">df_X_ind</span><span class="p">,</span>
                    <span class="n">fit</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_ind</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_X_ind</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_X_ind</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_ind</span> <span class="o">=</span> <span class="n">X_ind</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X_ind</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">concat</span> <span class="k">else</span> <span class="n">X</span></div>

<div class="viewcode-block" id="QSPRDataset.getTargetProperties"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.getTargetProperties">[docs]</a>    <span class="k">def</span> <span class="nf">getTargetProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concat</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the response values (training and test) for the set target property.</span>

<span class="sd">        Args:</span>
<span class="sd">            concat (bool): if `True`, return concatenated training and validation set target properties</span>

<span class="sd">        Returns:</span>
<span class="sd">            `tuple` of (train_responses, test_responses) or `pandas.DataFrame` of all target property values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">concat</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div>

<div class="viewcode-block" id="QSPRDataset.loadFeatureStandardizer"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.loadFeatureStandardizer">[docs]</a>    <span class="k">def</span> <span class="nf">loadFeatureStandardizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load feature standardizer from the metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `SKLearnStandardizer`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;standardizer_path&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span><span class="p">[</span><span class="s1">&#39;standardizer_path&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">SKLearnStandardizer</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">metaInfo</span><span class="p">[</span><span class="s1">&#39;standardizer_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="QSPRDataset.saveFeatureStandardizer"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.saveFeatureStandardizer">[docs]</a>    <span class="k">def</span> <span class="nf">saveFeatureStandardizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save feature standardizers to the metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `list` of `str`: paths to the saved standardizers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="si">}</span><span class="s1">_feature_standardizer.json&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># make sure feature standardizers are fitted before serialization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitFeatureStandardizer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="o">.</span><span class="n">toFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_standardizer</span><span class="o">.</span><span class="n">toFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="QSPRDataset.saveMetadata"><a class="viewcode-back" href="../../../api/qsprpred.data.html#qsprpred.data.data.QSPRDataset.saveMetadata">[docs]</a>    <span class="k">def</span> <span class="nf">saveMetadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save metadata to file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `str`: path to the saved metadata file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveFeatureStandardizer</span><span class="p">()</span>

        <span class="n">meta_init</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;target_prop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">originalTargetProperty</span><span class="p">,</span>
            <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;smilescol&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smilescol</span><span class="p">,</span>
            <span class="s1">&#39;th&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">th</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;init&#39;</span><span class="p">:</span> <span class="n">meta_init</span><span class="p">,</span>
            <span class="s1">&#39;standardizer_path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;descriptorcalculator_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculatorPath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">descriptorCalculatorPath</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;new_target_prop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetProperty</span><span class="p">,</span>
            <span class="s1">&#39;feature_names&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureNames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">storePrefix</span><span class="si">}</span><span class="s2">_meta.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Xuhan Liu, Sohvi Lukkonen, Helle van den Maagdenberg, Linde Schoenmaker, Martin Sicho.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>